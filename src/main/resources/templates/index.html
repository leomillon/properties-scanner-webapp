<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head th:fragment="htmlhead">
        <meta charset="utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>Properties Analyzer</title>

        <!-- Bootstrap -->
        <link th:href="@{/css/bootstrap.min.css}" href="../static/css/bootstrap-theme.min.css" rel="stylesheet"/>

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <style>
            .popover {
                max-width: 600px;
            }

            .property-value-cell code {
                word-break: break-all;
            }
        </style>
    </head>
    <body>
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#">Properties analyzer</a>
                </div>
            </div>
        </nav>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Property key</th>
                                <th>Definition state</th>
                                <th>Property value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr data-th-each="propertyReader : ${analyzedProperties.propertyReaders}">
                                <td class="property-key-cell"><code th:text="${propertyReader.key}">config.property.first</code></td>
                                <td class="property-state-cell">
                                    <div th:switch="${propertyReader.state.code}">
                                        <span th:case="'DUPLICATED'" class="label label-danger">DUPLICATED</span>
                                        <span th:case="'OVERRIDEN'" class="label label-warning">OVERRIDEN</span>
                                        <span th:case="'UNIQUE'" class="label label-success">UNIQUE</span>
                                    </div>
                                </td>
                                <td class="property-value-cell">
                                    <span class="history">
                                        <button type="button" class="btn btn-xs btn-default" data-toggle="popover" title="Value history"><span class="glyphicon glyphicon-list" aria-hidden="true"></span> <span data-th-text="(${#maps.size(propertyReader.history)})"></span></button>
                                        <div class="history-holder" style="display: none;">
                                            <div class="history-table">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Order</th>
                                                            <th>File name</th>
                                                            <th>Value</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr data-th-each="historyEntry,iterStat : ${propertyReader.history}">
                                                            <td th:text="${iterStat.count}">1</td>
                                                            <td><code th:text="${historyEntry.key.name}">file-name.properties</code></td>
                                                            <td class="property-value-cell"><code th:text="${historyEntry.value}">value1</code></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </span>
                                    <code class="last-value" th:attr="data-prop-key=${propertyReader.key}" th:text="${propertyReader.lastValue}">value1</code>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div th:fragment="scripts">
            <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
            <!-- Include all compiled plugins (below), or include individual files as needed -->
            <script th:src="@{/js/bootstrap.min.js}" src="../static/js/bootstrap.min.js"></script>
            <script>
                var popoverFallback = function() {
                    return $(this).siblings().filter('.history-holder').first().html();
                };
                $('.history button').popover(
                        {
                            html: true,
                            content: popoverFallback,
                            trigger: 'focus',
                            placement: 'auto'
                        }
                );

                function getValueForKey(key) {
                    return $(".last-value[data-prop-key='" + key + "']").text()
                }

                function findConcreteValue(propValue) {
                    if (propValue) {
                        var regex = /\$\{(.*?)}/g;
                        var matches=[];
                        var match = regex.exec(propValue);
                        while (match != null) {
                            matches.push(match[1]);
                            match = regex.exec(propValue);
                        }
                        //console.log("matches = " + matches);
                        for (var index in matches) {
                            var matchedKey = matches[index];
                            var matchedConcretValue = findConcreteValue(getValueForKey(matchedKey));
                            propValue = propValue.replace(new RegExp("\\${" + matchedKey + "}", "g"), matchedConcretValue);
                        }
                    }
                    return propValue;
                }

                $('.last-value').each(function() {
                    var currentElement = $(this);
                    var propValue = currentElement.text();
                    var concreteValue = findConcreteValue(propValue);
                    if (propValue != concreteValue) {
                        currentElement
                                .attr("title", concreteValue)
                                .tooltip();
                    }
                });
            </script>
        </div>
    </body>
</html>